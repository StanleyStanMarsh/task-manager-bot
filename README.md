## Task Management Bot

**Task Management Bot** — Telegram-бот для управления задачами, реализованный на основе Java Spring с использованием реактивного стека и модульной архитектуры.

---

### Технологический стек

* **Язык программирования:** Java 23
* **Spring Framework** (без Spring Boot)
* **Spring WebFlux** - реактивная обработка запросов
* **Spring Modulith** - модульная архитектура приложения
* **MongoDB** - документоориентированная база данных
* **HashiCorp Vault** - управление секретами и конфигурациями
* **Docker** + **Docker Compose** - контейнеризация и оркестрация сервисов
* **Telegram Bot API** - взаимодействие с пользователями
* **Undertow** - основной сервер для обработки HTTP запросов

---

### Архитектура

Приложение организовано в виде набора модулей в соответствии с модульной архитектурой Spring Modulith. Каждый модуль соответствует подпакету в `ru.spbstu.hsai` и решает определённую задачу:

* **Telegram** (`telegram`) - запуск бота, приём и обработка входящих обновлений, маршрутизация команд к соответствующим сервисам.
* **Usermanagement** (`usermanagement`) - управление пользователями: хранение профилей, прав и ролей.
* **Authors** (`authors`) - предоставление информации об авторах.
* **Check** (`check`) - эндпоинт для проверки работоспособности сервиса (Health Check).
* **Config** (`config`) - загрузка и управление конфигурацией (MongoDB, Vault, безопасность, WebFlux).
* **Infrastructure** (`infrastructure`) - служебные классы для запуска сервера и чтения системных свойств.
* **Notification** (`notification`) - планирование и отправка уведомлений о задачах.
* **Simpletaskmanagment** (`simpletaskmanagment`) - CRUD-операции для простых задач.
* **Repeatingtaskmanagment** (`repeatingtaskmanagment`) - CRUD-операции для повторяющихся задач.

Взаимосвязи между модулями:

* Модуль **Notification** использует **Repeatingtaskmanagment**, **Simpletaskmanagment**, **Usermanagement** и **Telegram** для формирования и отправки уведомлений.
* Модуль **Config** зависит от **Infrastructure**, **Check**, **Authors** и **Telegram** и использует **Usermanagement** для управления доступом к конфигурации.
* Модуль **Telegram** взаимодействует с **Authors**, **Usermanagement**, **Simpletaskmanagment** и **Repeatingtaskmanagment**, передавая команды пользователей в соответствующие сервисы.

![Граф зависимостей](diagram.png)

[**Документация Spring Modulith о взаимосвязях между модулями**](docs/index.html).

---

### Развёртывание

Для запуска проекта необходимо предварительно установить и настроить HashiCorp Vault, а также использовать `docker-compose` для развёртывания всех компонентов.

#### 1. Установка HashiCorp Vault

Скачайте Vault с [официального сайта](https://developer.hashicorp.com/vault/downloads). Распакуйте архив, содержащий единственный `vault.exe`, и добавьте путь к нему в системную переменную `PATH`. Проверьте установку командой:

```bash
vault -v
```

Если Vault установлен корректно, отобразится его версия.

#### 2. Подготовка окружения

В каталог с `docker-compose.yml` поместите следующие файлы:

* [`upload-to-vault.ps1`](upload-to-vault.ps1) — PowerShell-скрипт для загрузки секретов в контейнер Vault;
* `vault_root_token.txt` — файл, содержащий root-токен Vault (одна строка).

#### 3. Запуск Vault

Поднимите контейнер Vault:

```bash
docker compose up -d vault --build
```

Затем просмотрите логи контейнера и найдите строку с `Root Token:`. Скопируйте токен:

1. Вставьте его в `vault_root_token.txt` (одна строка без лишних символов);
2. Укажите этот токен в скрипте `upload-to-vault.ps1` в строке:

```powershell
$env:VAULT_TOKEN = "<ваш_токен>"
```

#### 4. Загрузка секретов в Vault

В PowerShell, при необходимости, разрешите выполнение скриптов:

```powershell
Set-ExecutionPolicy RemoteSigned –Force
```

Затем выполните:

```powershell
.\upload-to-vault.ps1
```

Если всё прошло успешно, появится сообщение о корректной отправке данных.

#### 5. Запуск приложения

Запустите оставшиеся контейнеры:

```bash
docker compose up --build
```

> Если требуется перезапуск без пересборки образов и с сохранением данных в базе, используйте команду без флага `--build`:

```bash
docker compose up
```

После корректного запуска всех сервисов Telegram-бот будет готов к использованию.

---


### Конфигурация

**Переменные окружения и секреты сервиса vault (нужно сконфигурировать [здесь](upload-to-vault.ps1)):**

* `VAULT_ADDR` - URL сервиса Vault
* `VAULT_TOKEN` - токен доступа к Vault
* `mongo.host` - хост для MongoDB
* `mongo.port` - порт для MongoDB
* `mongo.database` - имя базы данных MongoDB
* `mongo.username` и `mongo.password` - логин и пароль пользователя базы данных
* `telegram.bot.token` - токен Telegram-бота (можно получить у [BotFather](https://t.me/BotFather))
* `telegram.bot.username` - имя Telegram-бота
* `superadmin.telegramId`, `superadmin.username`, `superadmin.firstName`, `superadmin.lastName`, `superadmin.password` - данные для SUPER-ADMIN, который обладает особыми привилегиями

О загрузке секретов в Vault написано [в этом разделе](#4-загрузка-секретов-в-vault).

**Переменные окружения сервиса mongo (нужно сконфигурировать [здесь](docker-compose.yml)):**

* `MONGO_INITDB_ROOT_USERNAME` и `MONGO_INITDB_ROOT_PASSWORD` - логин и пароль пользователя базы данных (должен совпадать с `mongo.username` и `mongo.password` в передаваемых секретах)

**Переменные окружения и секреты сервиса app (нужно сконфигурировать [здесь](docker-compose.yml) и [здесь](vault_root_token.txt)):**

* `VAULT_ADDR` - адрес и порт для доступа к программе Vault в сервисе vault
* `VAULT_TOKEN_FILE` - путь до файла [vault_root_token](vault_root_token.txt), который экспортируется в качестве секрета в контейнер сервиса app
* ```yaml
    secrets:
      - vault_root_token
   ```

**Конфигурация секретов docker-compose:**

```yaml
secrets:
  vault_root_token:
    file: vault_root_token.txt

```

---

### Использование

#### HTTP эндпоинты

| Метод     | Путь                          | Описание                                                                                                                                                                | Права доступа                    |
|-----------|-------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|
| **GET**   | `/hello`                      | Базовый «приветственный» эндпоинт. Возвращает простое текстовое сообщение («Hello, World!») для проверки доступности сервиса.                                           | Любой (permitAll)                |
| **GET**   | `/healthcheck`                | Эндпоинт для проверки «здоровья» сервиса. Возвращает информацию о состоянии приложения (проверка доступности БД).                                                       | Любой (permitAll)                |
| **PATCH** | `/users/{telegramId}/promote` | Повысить роль пользователя с указанным `telegramId`. Присваивает роль `ADMIN`. Также передается новый пароль в теле запроса в формате JSON ({"password":"password123"}) | Только `ADMIN` или `SUPER-ADMIN` |
| **PATCH** | `/self_demote`                | Пользователь, уже обладающий ролью `ADMIN`, может понизить сам себя до обычного пользователя.                                                                           | Только `ADMIN` или `SUPER-ADMIN` |
| **PATCH** | `/users/{telegramId}/demote`  | Понизить роль пользователя с указанным `telegramId`. Удаляет роль `ADMIN`.                                                                                              | Только `SUPER_ADMIN`             |
| **GET**   | `/authors`                    | Возвращает список и информацию об авторах и администраторах бота.                                                                                                       | Любой (permitAll)                |
| **GET**   | `/users`                      | Возвращает список всех зарегистрированных пользователей (кроме данных `SUPER-ADMIN`).                                                                                   | Только `ADMIN` или `SUPER-ADMIN` |


#### Telegram команды

##### Управление задачами

| Команда             | Описание                                                                                                                          |
|---------------------|-----------------------------------------------------------------------------------------------------------------------------------|
| `/newtask`          | Создание новой одноразовой задачи. Пользователь последовательно вводит необходимые параметры (описание, дату, сложность и т. д.). |
| `/updatetask <ID>`  | Редактирование ранее созданной задачи по её уникальному идентификатору. Позволяет изменить параметры задачи.                      |
| `/deletetask <ID>`  | Удаление задачи по указанному идентификатору.                                                                                     |
| `/newrepeatingtask` | Создание повторяющейся задачи (ежечасной, ежедневной, еженедельной) с времени и других параметров.                                |

##### Просмотр задач

| Команда              | Описание                                                             |
|----------------------|----------------------------------------------------------------------|
| `/mytasks`           | Отображение списка всех активных (незавершённых) задач пользователя. |
| `/today`             | Список задач, запланированных на текущую дату.                       |
| `/week`              | Задачи, запланированные на текущую календарную неделю.               |
| `/date <дд.мм.гггг>` | Задачи на конкретную дату, введённую в формате `дд.мм.гггг`.         |
| `/completed`         | Просмотр завершённых задач пользователя.                             |

##### Служебные и информационные команды

| Команда    | Описание                                                        |
|------------|-----------------------------------------------------------------|
| `/start`   | Регистрация нового пользователя и присвоение часового пояса     |
| `/status`  | Отображение текущего состояния бота и его ключевых компонентов. |
| `/authors` | Информация об авторах и администраторах проекта.                |
| `/help`    | Вывод справочного сообщения со списком команд                   |


---

### Безопасность

* Секреты (токены и учетные данные) не хранятся в коде и конфигурационных файлах — все секреты управляются через Vault.
* Сервисы изолированы в отдельных Docker-контейнерах.
* Доступ к Vault и MongoDB ограничен соответствующими политиками.

---

### Лицензия

Проект распространяется под лицензией MIT. Подробнее см. файл [LICENSE](LICENSE).

---

